const getProcessNumber = () => {
  /*
    texto para extrair
    ...
    //CA=200
    Nos[0] = new infraArvoreNo("PROCESSO","5523",null,"controlador.php?acao=arvore_visualizar&acao_origem=procedimento_visualizar&id_procedimento=5523&infra_sistema=100000100&infra_unidade_atual=110000302&infra_hash=3eea95e3b70b372ae7b770873cdc4b2eb6d93185b2f1e12f86e7ea49c0d375fa","ifrVisualizacao","08660018176/2014-60","Corregedoria: Processo Disciplinar","imagens/procedimento.gif","imagens/procedimento.gif","imagens/procedimento.gif",true,true,null,null,null);
    Nos[0].acoes = '<a href="controlador.php?acao=documento_escolher_tipo&acao_origem=arvore_visualizar&acao_retorno=arvore_visualizar&id_procedimento=5523&arvore=1&infra_sistema=100000100&infra_unidade_atual=110000302&infra_hash=8438945486f66740cd7cb831df1d2f811c126e9e34c1fad2d2be1da2911a1919" tabindex="451" class="botaoSEI"><img class="infraCorBarraSistema"  src="imagens/sei_incluir_documento.gif" alt="Incluir Documento" title="Incluir Documento"/></a><a href="controlador.php?acao=procedimento_escolher_tipo_relacionado&acao_origem=arvore_visualizar&acao_retorno=arvore_visualizar&id_procedimento_destino=5523&arvore=1&infra_sistema=100000100&infra_unidade_atual=110000302&infra_hash=686b035aa468e9448e77928022c3a14ffdcdf980835d06120f158773a7d61d4e" tabindex="451" class="botaoSEI"><img class="infraCorBarraSistema" src="imagens/sei_gerar_processo_relacionado.gif" alt="Iniciar Processo Relacionado" title="Iniciar Processo Relacionado"/></a><a href="controlador.php?acao=procedimento_alterar&acao_origem=arvore_visualizar&acao_retorno=arvore_visualizar&id_procedimento=5523&arvore=1&infra_sistema=100000100&infra_unidade_atual=110000302&infra_hash=aa4c13aafd842a0464345629d52988a9c5fdd0a6eb9369a2885af05f5472e970" tabindex="451" class="botaoSEI"><img class="infraCorBarraSistema" src="imagens/sei_consultar_alterar_protocolo.gif" alt="Consultar/Alterar Processo" title="Consultar/Alterar Processo"/></a><a href="controlador.php?acao=acompanhamento_cadastrar&acao_origem=arvore_visualizar&acao_retorno=arvore_visualizar&id_procedimento=5523&arvore=1&infra_sistema=100000100&infra_unidade_atual=110000302&infra_hash=c65517df2fed8b5d5315f3a968c89a2b132dbf7ccdef5b4c86443dcfdc1c986e" tabindex="451" class="botaoSEI"><img class="infraCorBarraSistema" src="imagens/sei_acompanhamento_especial.gif" alt="Acompanhamento Especial" title="Acompanhamento Especial"/></a><a href="#" onclick="cienciaProcesso();" tabindex="451" class="botaoSEI"><img class="infraCorBarraSistema"  tabindex="451" src="imagens/sei_ciencia.gif" alt="Ciência" title="Ciência" /><a href="controlador.php?acao=procedimento_enviar&acao_origem=arvore_visualizar&acao_retorno=arvore_visualizar&id_procedimento=5523&arvore=1&infra_sistema=100000100&infra_unidade_atual=110000302&infra_hash=d8742cedc73928d393e3ffe8dd16bed7a38f8482b9c8817785630c92396225d1" tabindex="451" class="botaoSEI"><img class="infraCorBarraSistema" src="imagens/sei_enviar_processo.gif" alt="Enviar Processo" title="Enviar Processo" /></a><a href="controlador.php?acao=procedimento_atualizar_andamento&acao_origem=arvore_visualizar&acao_retorno=arvore_visualizar&id_procedimento=5523&arvore=1&infra_sistema=100000100&infra_unidade_atual=110000302&infra_hash=234ec6462d11e991ae36f95335758e032798518222f0b07939b232d90d484e97" tabindex="451" class="botaoSEI"><img class="infraCorBarraSistema" src="imagens/sei_atualizar_andamento.gif" alt="Atualizar Andamento" title="Atualizar Andamento" /></a><a href="controlador.php?acao=procedimento_atribuicao_cadastrar&acao_origem=arvore_visualizar&acao_retorno=arvore_visualizar&id_procedimento=5523&arvore=1&infra_sistema=100000100&infra_unidade_atual=110000302&infra_hash=8d865676783af4299b7bc0541ee5c6478c4f470d0de14c0dc02282441553a962" tabindex="451" class="botaoSEI"><img class="infraCorBarraSistema" src="imagens/sei_atribuir_processo.gif" alt="Atribuir Processo" title="Atribuir Processo" /></a><a href="controlador.php?acao=procedimento_duplicar&acao_origem=arvore_visualizar&acao_retorno=arvore_visualizar&id_procedimento=5523&arvore=1&infra_sistema=100000100&infra_unidade_atual=110000302&infra_hash=df7498f5a5b312bc99dfda3cf86e3ed86e67dfc20b76167c3080a6f708b0ea7a" tabindex="451" class="botaoSEI"><img class="infraCorBarraSistema" src="imagens/sei_duplicar_procedimento.gif" alt="Duplicar Processo" title="Duplicar Processo"/></a><a href="#" onclick="enviarEmailProcedimento();" tabindex="451" class="botaoSEI"><img class="infraCorBarraSistema"  tabindex="451" src="imagens/sei_email.gif" alt="Enviar Correspondência Eletrônica" title="Enviar Correspondência Eletrônica"/><a href="controlador.php?acao=procedimento_relacionar&acao_origem=arvore_visualizar&acao_retorno=arvore_visualizar&id_procedimento=5523&arvore=1&infra_sistema=100000100&infra_unidade_atual=110000302&infra_hash=683df05074479d77e3a2831be5e35bed9396a2b36e0079eef4fe4c7d3289d02e" tabindex="451" class="botaoSEI"><img class="infraCorBarraSistema" src="imagens/sei_relacionados.png" alt="Relacionamentos do Processo" title="Relacionamentos do Processo"/></a><a href="#" onclick="incluirEmBloco();" tabindex="451" class="botaoSEI"><img class="infraCorBarraSistema"  tabindex="451" src="imagens/sei_incluir_em_bloco.gif" alt="Incluir em Bloco" title="Incluir em Bloco"/><a href="controlador.php?acao=arvore_ordenar&acao_origem=arvore_visualizar&acao_retorno=arvore_visualizar&id_procedimento=5523&arvore=1&infra_sistema=100000100&infra_unidade_atual=110000302&infra_hash=c0fcf66699f20f74bf37bfafe4dd4c776dfeb96c2b7d921899a9c19c76f57a88" tabindex="451" class="botaoSEI"><img class="infraCorBarraSistema" src="imagens/sei_ordenar_arvore.gif" alt="Ordenar Árvore do Processo" title="Ordenar Árvore do Processo"/></a><a href="controlador.php?acao=acesso_externo_gerenciar&acao_origem=arvore_visualizar&acao_retorno=arvore_visualizar&id_procedimento=5523&arvore=1&infra_sistema=100000100&infra_unidade_atual=110000302&infra_hash=445cc1102ad7f66f11946a82c82bdb8dc192d3bd32568ad77df4ae35e24223b7" tabindex="451" class="botaoSEI"><img class="infraCorBarraSistema" src="imagens/sei_acesso_externo.gif" alt="Gerenciar Disponibilizações de Acesso Externo" title="Gerenciar Disponibilizações de Acesso Externo"/></a><a href="controlador.php?acao=anotacao_registrar&acao_origem=arvore_visualizar&acao_retorno=arvore_visualizar&id_procedimento=5523&arvore=1&infra_sistema=100000100&infra_unidade_atual=110000302&infra_hash=7e986ca5dd82d1cf8c1ca82d01fe9394d9cfd4301a9e7151ce4f96dee5a34281" tabindex="451" class="botaoSEI"><img class="infraCorBarraSistema" src="imagens/sei_anotacao.gif" alt="Anotações" title="Anotações" /></a><a href="controlador.php?acao=procedimento_sobrestar&acao_origem=arvore_visualizar&acao_retorno=arvore_visualizar&id_procedimento=5523&arvore=1&infra_sistema=100000100&infra_unidade_atual=110000302&infra_hash=6567a482b9613cc39c8b22632da4356730ad9ef641e0014850016d386e8a3ccc" tabindex="451" class="botaoSEI"><img class="infraCorBarraSistema" src="imagens/sei_sobrestar_processo.gif" alt="Sobrestar Processo" title="Sobrestar Processo" /></a><a href="controlador.php?acao=procedimento_anexar&acao_origem=arvore_visualizar&acao_retorno=arvore_visualizar&id_procedimento=5523&arvore=1&infra_sistema=100000100&infra_unidade_atual=110000302&infra_hash=bcd8c8934d39d3cc02968ba74e5569e3a956a5ec0ca28674cb7867b9b912c755" tabindex="451" class="botaoSEI"><img class="infraCorBarraSistema" src="imagens/sei_anexar_processo.gif" alt="Anexar Processo" title="Anexar Processo" /></a><a href="#" onclick="concluirProcesso();" tabindex="451" class="botaoSEI"><img class="infraCorBarraSistema"  tabindex="451" src="imagens/sei_concluir_processo.gif" alt="Concluir Processo" title="Concluir Processo" /><a href="controlador.php?acao=procedimento_gerar_pdf&acao_origem=arvore_visualizar&acao_retorno=arvore_visualizar&id_procedimento=5523&arvore=1&infra_sistema=100000100&infra_unidade_atual=110000302&infra_hash=f49848000606ee3d8ffa5235a3324995f010756b7fad01974133c5aaf8714945" tabindex="451" class="botaoSEI"><img class="infraCorBarraSistema" src="imagens/sei_gerar_arquivo_processo.gif" alt="Gerar Arquivo PDF do Processo" title="Gerar Arquivo PDF do Processo"/></a><a href="controlador.php?acao=procedimento_gerar_zip&acao_origem=arvore_visualizar&acao_retorno=arvore_visualizar&id_procedimento=5523&arvore=1&infra_sistema=100000100&infra_unidade_atual=110000302&infra_hash=80a5df0ad0da9ac35fb30a0fa40aa4d007d5d56e3f2bc167017835ea0512b583" tabindex="451" class="botaoSEI"><img class="infraCorBarraSistema" src="imagens/sei_gerar_zip_processo.png" alt="Gerar Arquivo ZIP do Processo" title="Gerar Arquivo ZIP do Processo"/></a><a href="controlador.php?acao=andamento_situacao_gerenciar&acao_origem=procedimento_visualizar&acao_retorno=arvore_visualizar&id_procedimento=5523&arvore=1&infra_sistema=100000100&infra_unidade_atual=110000302&infra_hash=03d45d83718c1840bc97701987ee2ddd8f2f36b2e9ecbef8adff8c42f3e96252" tabindex="451" class="botaoSEI"><img class="infraCorBarraSistema" src="imagens/sei_situacao.png" alt="Gerenciar Ponto de Controle" title="Gerenciar Ponto de Controle" /></a><a href="controlador.php?acao=andamento_marcador_gerenciar&acao_origem=procedimento_visualizar&acao_retorno=arvore_visualizar&id_procedimento=5523&arvore=1&infra_sistema=100000100&infra_unidade_atual=110000302&infra_hash=8ae17941f7fce3f459ca1b3201b3b187bd15d4894e491c6e096b715e50a871c7" tabindex="451" class="botaoSEI"><img class="infraCorBarraSistema" src="imagens/sei_marcador.png" alt="Gerenciar Marcador" title="Gerenciar Marcador" /></a><a href="#" onclick="parent.parent.document.location.href=\'controlador.php?acao=procedimento_controlar&acao_origem=procedimento_visualizar&acao_retorno=principal&infra_sistema=100000100&infra_unidade_atual=110000302&infra_hash=8d1ed58652197549958a224016c9ab108a0d83dfbac7b96e7283045f9ac03b0e#ID-5523\';" tabindex="451" class="botaoSEI"><img class="infraCorBarraSistema" src="imagens/sei_controle_processos.gif" alt="Controle de Processos" title="Controle de Processos" /></a><a href="controlador.php?acao=procedimento_pesquisar&acao_origem=procedimento_visualizar&acao_retorno=arvore_visualizar&id_procedimento=5523&arvore=1&infra_sistema=100000100&infra_unidade_atual=110000302&infra_hash=84e54cea6ce5b31f6d2b10a0c4145e91538c84d075e8be9b0aff76f11d8eef60" tabindex="451" class="botaoSEI"><img class="infraCorBarraSistema" src="imagens/sei_pesquisa.png" alt="Pesquisar no Processo" title="Pesquisar no Processo" /></a>';
    ...
  */

  const lastScript = document.scripts[document.scripts.length - 1];
  const scriptContent = lastScript.innerText;
  const regex = /Nos\[0\] = new infraArvoreNo\(.*?ifrVisualizacao","([\d./-]+)",".*;/;
  const match = regex.exec(scriptContent);
  if (!match || match.length !== 2) return null;
  return match[1];
};

const checkIfSEI3015 = () => {
  return !!document.querySelector('div#header') && !!document.querySelector('div#container');
};

const addTrelloBox = () => {
  if (checkIfSEI3015()) document.documentElement.classList.add('sei-v3015');

  const body = document.querySelector('body');

  const processNumber = getProcessNumber();

  if (!processNumber) return; /* couldn't find a process number */

  const trelloBox = document.createElement('div');
  trelloBox.setAttribute('data-trello-process-box', '');
  trelloBox.setAttribute('data-trello-process-number', processNumber);

  /* add trello card placeholder */
  const cardPlaceholder = document.createElement('div');
  cardPlaceholder.classList.add('trello-card');
  cardPlaceholder.setAttribute('data-full-width', '');
  trelloBox.appendChild(cardPlaceholder);

  /* add create trello card button placeholder */
  const createCardPlaceHolder = document.createElement('div');
  createCardPlaceHolder.classList.add('trello-create-card-button');
  trelloBox.appendChild(createCardPlaceHolder);

  body.insertAdjacentElement('afterbegin', trelloBox);
};

export const prepare = () => {
  addTrelloBox();
};
